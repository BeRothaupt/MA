% !TeX root = ../../../Main.tex
\chapter{Results}
\label{chapter6}

\section{2D Policy Iteration}
\label{sec:results2d}
In the 2D scenario, three Dynamic Programming algorithms are compared:

\begin{itemize}
	\item Generalized policy iteration with up to 100 evaluation iterations before each improvement step
	\item Optimistic policy iteration
	\item Value iteration
\end{itemize}

For comparison, three scenarios in calm air are compared. In scenario 1, the agent has to cover a distance of 500m through calm air. In scenario 2, the distance is 1000m, in the third scenario, the distance is 2000m.

Recall that policy iteration algorithms produce a sequence of value-functions and policies that approximate $V_*$ and $\pi_*$. Each iterate $V_{k+1}$ and $\pi_{k+1}$ is closer to $V_*$ and $\pi_*$ than its predecessor $V_k$ and $\pi_k$. Value iteration only iterates state value functions. If a close approximation of $V_*$ is found, a policy can be derived by acting greedily with respect to the last value function iterate.

In the GPI algorithm, the iterative evaluation stops, if the values of all states change by less than the reward for one time step $\Delta t$ from one evaluation step to the next. When this point is reached, only the time penalty propagates through the network. At states $s_t$, where the agent only moves slowly, chances are that the successor state $s_{t+1}$ is (roughly) equal to $s_t$ (and therefore $V(s_t)=V(s_{t+1})$). In such cases, the state value $V(s_t)$ is overwritten with $r_t + V(s_t)$ at each iteration. This goes on indefinitely if PE is not stopped manually. Every policy iteration where the evaluation step is repeated obviously takes longer than an optimistic policy iteration.

As value iteration combines one step of policy evaluation and policy improvement in every iteration. One value iteration therefore usually takes less time than one optimistic policy iteration.

The Policy Iteration has converged if - at the last Policy Improvement step - none of the actions have changed. This means that all actions were already optimal with respect to the current value function prior to the improvement step.

In scenario 1, the agent has to cover 500m while flying through calm air. Table \ref{tab:2d_flight_data_500m} shows the flight times from the start-state to the goal after policy optimization with GPI, OPI and VI. As a benchmark, the optimal control \nomenclature[A]{OC}{optimal control} is shown in the first column. Calculation time is the time it took to obtain the given trajectories and control sequences. Note that lower calculation and flight times are better. As mentioned before, value iteration takes the least time for one iteration and converges before OPI and GPI.

Although all three DP algorithms theoretically take up to $|\mathcal{A}|^{|\mathcal{S}|}$ iterations to converge (c.f. section \ref{sec:PI}), they are known to typically converge after surprisingly few iterations. This is also the case in this scenario.

\begin{table}[h]
	\begin{center}
		\begin{tabular}{r|c c c c}
			distance $d_T$ & \multicolumn{4}{c}{500m} \\ \hline 
			algorithm & OC & GPI & OPI & VI \\
			approx. time per iteration (s) & - & 700 & 205 & 190 \\
			iterations & - & 18 & 23 & 20 \\
			calculation time (s) & 901.3 & 7245 & 4753 & 3746 \\
			flight time (s) & 19.67 & 21.2 & 22.0  & 21.4
		\end{tabular}
		\caption{Comparison of flight- and computation-time for OC, GPI, OPI and VI}
		\label{tab:2d_flight_data_500m}
	\end{center}
\end{table}

All algorithms yield a similar flight time that is approximately two seconds slower than the optimal control flight time. As all algorithms converge to a reasonable solution, GPI is not used for scenarios 2 and 3, because OPI and VI converge faster and calculation time gets more critical at higher distances, i.e. more grid points.

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/opti500m.dat}}\dataOPTIfiveH

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/opti1000m.dat}}\dataOPTIoneK

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/dat-no68-i27-500m-dt250ms.dat}}\dataOPIfiveH

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/dat-no60-i18-500m-dt250ms.dat}}\dataGPIfiveH

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/dat-no62-i20-500m-dt250ms.dat}}\dataVIfiveH

\pgfplotstableread[col sep=comma] {\detokenize{./src/pics/tikz/dat-no72-i43-1000m-dt250ms.dat}}\dataVIoneK

\pgfplotstableread[col sep=comma]
{\detokenize{./src/pics/tikz/trpo-glorot-vs-vi-1000m-AverageReturn}}\trpoGlorotVsVIoneKAvgReturn

\pgfplotstableread[col sep=comma]
{\detokenize{./src/pics/tikz/trpo-glorot-vs-vi-1000m-MaxReturn}}\trpoGlorotVsVIoneKMaxReturn

\tikzsetnextfilename{optiandgpi500m}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=500,
		legend pos=north east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=0, ymax=100,
	axis y line*=left,
	xlabel={distance (m)},
	xlabel near ticks,
	ylabel={height $-z$ (m)},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataOPTIfiveH};
	\addplot[blue, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataGPIfiveH};
	\end{axis}
	
	\begin{axis}[
	clip mode=individual,
	ymin=0, ymax=0.2,
	axis y line*=right,
	xtick=\empty,
	xlabel=\empty,
	%xlabel near ticks,
	ylabel={$\alpha$ (rad)},
	ylabel near ticks,
	]
	% aircraft controls
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=2]{\dataOPTIfiveH};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=4]{\dataGPIfiveH};
	
	\addlegendimage{red,line width=1.2pt, mark=none}\addlegendentry{OC}
	\addlegendimage{red,line width=0.5pt, mark=none}\addlegendentry{OC - control sequence}
	\addlegendimage{blue,line width=1.2pt, mark=none}\addlegendentry{GPI}
	\addlegendimage{blue,line width=0.5pt, mark=none}\addlegendentry{GPI - control sequence}
	
	\end{axis}
	
	\foreach \gridrow in {1,2,3,4,5}{
		\draw[color=gray] (0,0.409*\textheight - \gridrow*0.02045*\textheight) -- + (0.2*\textwidth-0.03*\textwidth*\gridrow,0);
	}
	\foreach \gridcol in {1,2,3,4,5}{
		\draw[color=gray] (\gridcol*0.03*\textwidth,0.409*\textheight) -- + (0,-0.14*\textheight+0.02*\textheight*\gridcol);
}
	
	\end{tikzpicture}
	\caption{Results of generalized policy iteration (blue) and optimal control (red)}
	\label{tikz:gpi500m}
\end{figure}

Figure \ref{tikz:gpi500m} shows the agent's trajectory optimized with GPI. Optimization took approximately two hours (c.f. table \ref{tab:2d_flight_data_500m}). Qualitatively, the control sequence is very similar to the optimal control sequence. Within the first 50m of horizontal movement, there is some stutter in the control sequence which leads to a suboptimal trajectory. 

In the upper left corner, a small part of the state grid is drawn. The grid elements have their original size with respect to the height and the distance.


\tikzsetnextfilename{optiandopi500m}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=500,
		legend pos=north east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=0, ymax=100,
	axis y line*=left,
	xlabel={distance (m)},
	xlabel near ticks,
	ylabel={height $-z$ (m)},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataOPTIfiveH};
	\addplot[blue, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataOPIfiveH};
	\end{axis}
	
	\begin{axis}[
	clip mode=individual,
	ymin=0, ymax=0.2,
	axis y line*=right,
	xtick=\empty,
	xlabel=\empty,
	%xlabel near ticks,
	ylabel={$\alpha$ (rad)},
	ylabel near ticks,
	]
	% aircraft controls
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=2]{\dataOPTIfiveH};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=4]{\dataOPIfiveH};
	
	\addlegendimage{red,line width=1.2pt, mark=none}\addlegendentry{Optimal Trajectory}
	\addlegendimage{red,line width=0.5pt, mark=none}\addlegendentry{Optimal Control Sequence}
	\addlegendimage{blue,line width=1.2pt, mark=none}\addlegendentry{Optimistic Policy Iteration: Trajectory}
	\addlegendimage{blue,line width=0.5pt, mark=none}\addlegendentry{Optimistic Policy Iteration: Control Sequence}
	
	\end{axis}
	
	\end{tikzpicture}
	\caption{Results of optimistic policy iteration (blue) and optimal control (red)}
	\label{tikz:opi500m}
\end{figure}

\tikzsetnextfilename{optiandvi500m}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=500,
		legend pos=north east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=0, ymax=100,
	axis y line*=left,
	xlabel={distance (m)},
	xlabel near ticks,
	ylabel={height $-z$ (m)},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataOPTIfiveH};
	\addplot[blue, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataVIfiveH};
	\end{axis}
	
	\begin{axis}[
	clip mode=individual,
	ymin=0, ymax=0.2,
	axis y line*=right,
	xtick=\empty,
	xlabel=\empty,
	%xlabel near ticks,\dataOPTIoneK
	ylabel={$\alpha$ (rad)},
	ylabel near ticks,
	]
	% aircraft controls
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=2]{\dataOPTIfiveH};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=4]{\dataVIfiveH};
	
	\addlegendimage{red,line width=1.2pt, mark=none}\addlegendentry{Optimal Trajectory}
	\addlegendimage{red,line width=0.5pt, mark=none}\addlegendentry{Optimal Control Sequence}
	\addlegendimage{blue,line width=1.2pt, mark=none}\addlegendentry{Value Iteration: Trajectory}
	\addlegendimage{blue,line width=0.5pt, mark=none}\addlegendentry{Value Iteration: Control Sequence}
	
	\end{axis}
	
	\end{tikzpicture}
	\caption{Results of value iteration (blue) and optimal control (red)}
	\label{tikz:vi500m}
\end{figure}

In scenario 2, $d_T$ is 1000m.

Figure \ref{tikz:vi1000m} shows in blue the trajectory in scenario 1 after 43 value iterations. The thick line is the glider trajectory $[x(t),z(t)]^T$, the thin line is the control sequence $[x(t),\alpha(t)]^T$ The agent is dropped at the start state with zero velocity. As can be seen, both the policy from VI and the optimal control (red) direct the agent towards the target.

\begin{table}[h]
	\begin{center}
		\begin{tabular}{r|c c c c}
			distance $d_T$ & \multicolumn{3}{c}{1000m} \\ \hline 
			algorithm & OC & OPI & VI \\
			approx. time per iteration (s) & - & & 423 \\
			iterations & - &  & 43 \\
			calculation time (h:min) & 1:31 & & 5:03 \\
			flight time (s) & 47.04  & & 52.1
		\end{tabular}
		\caption{Comparison of flight- and computation-time for OC, OPI and VI}
		\label{tab:2d_flight_data_1000m}
	\end{center}
\end{table}

Both algorithms yield policies that are able to find the goal from various initial states. 

\tikzsetnextfilename{optiandvi1000m}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=1000,
		legend pos=north east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=0, ymax=100,
	axis y line*=left,
	xlabel={distance (m)},
	xlabel near ticks,
	ylabel={height $-z$ (m)},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataOPTIoneK};
	\addplot[blue, line width=1.2pt, mark=none,forget plot] table[x index=0, y index=1]{\dataVIoneK};
	\end{axis}
	
	\begin{axis}[
	clip mode=individual,
	ymin=0, ymax=0.2,
	axis y line*=right,
	xtick=\empty,
	xlabel=\empty,
	%xlabel near ticks,
	ylabel={$\alpha$ (rad)},
	ylabel near ticks,
	]
	% aircraft controls
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=2]{\dataOPTIoneK};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=4]{\dataVIoneK};
	
	\addlegendimage{red,line width=1.2pt, mark=none}\addlegendentry{Optimal Trajectory}
	\addlegendimage{red,line width=0.5pt, mark=none}\addlegendentry{Optimal Control Sequence}
	\addlegendimage{blue,line width=1.2pt, mark=none}\addlegendentry{Value Iteration: Trajectory}
	\addlegendimage{blue,line width=0.5pt, mark=none}\addlegendentry{Value Iteration: Control Sequence}
	
	\end{axis}
	
	\end{tikzpicture}	
	\caption{Results of value iteration (blue) and optimal control (red)}
	\label{tikz:vi1000m}
\end{figure}

\tikzsetnextfilename{trpoglorotvsvi1000mAvg}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.5\textwidth,
		height=0.4\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=200,
		legend pos=south east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=20, ymax=60,
	axis y line*=left,
	xlabel={iteration},
	xlabel near ticks,
	ylabel={Average Return},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=1]{\trpoGlorotVsVIoneKAvgReturn};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=2]{\trpoGlorotVsVIoneKAvgReturn};

	\end{axis}
		
	\end{tikzpicture}
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=800,
		legend pos=south east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=-20, ymax=60,
	axis y line*=left,
	xlabel={iteration},
	xlabel near ticks,
	ylabel={Average Return},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=1]{\trpoGlorotVsVIoneKAvgReturn};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=2]{\trpoGlorotVsVIoneKAvgReturn};
	
	\addlegendimage{red,line width=0.8pt, mark=none}\addlegendentry{glorot uniform initialization}
	\addlegendimage{blue,line width=0.8pt, mark=none}\addlegendentry{value iteration}
	
	\end{axis}
	
	\end{tikzpicture}	
	\caption{Average return per iteration with and without policy initialization}
	\label{tikz:trpoglorotvi1000mAvg}
\end{figure}

\tikzsetnextfilename{trpoglorotvsvi1000mMax}
\begin{figure}[hbt]
	\centering
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.5\textwidth,
		height=0.4\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=200,
		legend pos=south east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=20, ymax=60,
	axis y line*=left,
	xlabel={iteration},
	xlabel near ticks,
	ylabel={Average Return},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=1]{\trpoGlorotVsVIoneKMaxReturn};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=2]{\trpoGlorotVsVIoneKMaxReturn};
	
	\end{axis}
	
	\end{tikzpicture}
	\begin{tikzpicture}
	
	\pgfplotsset{
		width=0.85\textwidth,
		height=0.65\textwidth, 
		xmajorgrids, 
		ymajorgrids, 
		enlarge x limits=false,
		scaled x ticks = false,
		x tick label style={/pgf/number format/.cd, fixed, set thousands separator={}},
		scaled y ticks = false,
		yticklabel style={/pgf/number format/.cd, fixed, set thousands separator={}},
		xmin=0, xmax=800,
		legend pos=south east,
		legend cell align=left
	}
	
	\begin{axis}[
	% hide x-axis once
	% grid andeuten (andere Farbe)
	clip mode=individual,
	ymin=-20, ymax=60,
	axis y line*=left,
	xlabel={iteration},
	xlabel near ticks,
	ylabel={Average Return},
	ylabel near ticks,
	]	
	% aircraft trajectory
	\addplot[red, line width=0.5pt, mark=none,forget plot] table[x index=0, y index=1]{\trpoGlorotVsVIoneKMaxReturn};
	\addplot[blue, line width=0.5pt, mark=none,forget plot] table[x index=0, y 
	index=2]{\trpoGlorotVsVIoneKMaxReturn};
	
	\addlegendimage{red,line width=0.8pt, mark=none}\addlegendentry{glorot uniform initialization}
	\addlegendimage{blue,line width=0.8pt, mark=none}\addlegendentry{value iteration}
	
	\end{axis}
	
	\end{tikzpicture}	
	\caption{Maximum return per iteration with and without policy initialization}
	\label{tikz:trpoglorotvi1000mMax}
\end{figure}